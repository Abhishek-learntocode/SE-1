@startuml User_and_Role_Management_Subsystem

' ============================================================
' User and Role Management Subsystem - Apache Roller
' ============================================================

' Manager Interface
interface UserManager <<interface>> {
    + addUser(user: User): void
    + saveUser(user: User): void
    + removeUser(user: User): void
    + getUser(id: String): User
    + getUserByUserName(userName: String): User
    + getUserByUserName(userName: String, enabled: Boolean): User
    + getUserByActivationCode(activationCode: String): User
    + getUsers(enabled: Boolean, startDate: Date, endDate: Date, offset: int, length: int): List<User>
    + getUserCount(): long
    + grantWeblogPermission(weblog: Weblog, user: User, actions: List<String>): void
    + revokeWeblogPermission(weblog: Weblog, user: User, actions: List<String>): void
    + getWeblogPermissions(user: User): List<WeblogPermission>
    + getWeblogPermissions(weblog: Weblog): List<WeblogPermission>
    + getWeblogPermission(weblog: Weblog, user: User): WeblogPermission
    + getPendingWeblogPermissions(user: User): List<WeblogPermission>
    + getPendingWeblogPermissions(weblog: Weblog): List<WeblogPermission>
    + confirmWeblogPermission(weblog: Weblog, user: User): void
    + declineWeblogPermission(weblog: Weblog, user: User): void
    + checkPermission(permission: WeblogPermission, user: User): boolean
}

' Domain Model Classes
class User {
    - id: String
    - userName: String
    - password: String
    - openIdUrl: String
    - screenName: String
    - fullName: String
    - emailAddress: String
    - dateCreated: Date
    - locale: String
    - timeZone: String
    - enabled: Boolean
    - activationCode: String
    
    + getId(): String
    + getUserName(): String
    + getPassword(): String
    + setPassword(password: String): void
    + getScreenName(): String
    + getFullName(): String
    + getEmailAddress(): String
    + getDateCreated(): Date
    + getLocale(): String
    + getTimeZone(): String
    + getEnabled(): Boolean
    + getActivationCode(): String
    + resetPassword(): String
    + hasGlobalRole(roleName: String): boolean
}

abstract class ObjectPermission {
    # id: String
    # userName: String
    # pending: boolean
    # objectType: String
    # objectId: String
    # actions: String
    
    # ObjectPermission(name: String)
    + getId(): String
    + getUserName(): String
    + setUserName(userName: String): void
    + isPending(): boolean
    + setPending(pending: boolean): void
    + getObjectType(): String
    + getObjectId(): String
    + getActions(): String
    + setActions(actions: String): void
    + getActionsAsList(): List<String>
    + setActionsAsList(actions: List<String>): void
    + hasAction(action: String): boolean
    + implies(permission: Permission): boolean
}

class WeblogPermission {
    + {static} EDIT_DRAFT: String = "edit_draft"
    + {static} POST: String = "post"
    + {static} ADMIN: String = "admin"
    + {static} ALL_ACTIONS: List<String>
    
    + WeblogPermission()
    + WeblogPermission(weblog: Weblog, user: User, actions: String)
    + WeblogPermission(weblog: Weblog, user: User, actions: List<String>)
    + WeblogPermission(weblog: Weblog, actions: List<String>)
    + getWeblog(): Weblog
    + getUser(): User
    + hasAction(action: String): boolean
}

class RollerPermission {
    + {static} ADMIN: String = "admin"
    
    + RollerPermission(user: User, actions: String)
    + RollerPermission(user: User, actions: List<String>)
    + getUser(): User
}

class Weblog <<external>> {
    - id: String
    - handle: String
    - name: String
    - creator: String
    
    + getId(): String
    + getHandle(): String
    + getName(): String
    + getCreator(): String
}

' Security Integration (Spring Security)
class RollerUserDetails {
    - user: User
    - authorities: List<GrantedAuthority>
    
    + RollerUserDetails(user: User)
    + getAuthorities(): Collection<GrantedAuthority>
    + getPassword(): String
    + getUsername(): String
    + isAccountNonExpired(): boolean
    + isAccountNonLocked(): boolean
    + isCredentialsNonExpired(): boolean
    + isEnabled(): boolean
    + getUser(): User
}

interface UserDetailsService <<interface>> {
    + loadUserByUsername(username: String): UserDetails
}

interface UserDetails <<interface>> {
    + getAuthorities(): Collection<GrantedAuthority>
    + getPassword(): String
    + getUsername(): String
    + isAccountNonExpired(): boolean
    + isAccountNonLocked(): boolean
    + isCredentialsNonExpired(): boolean
    + isEnabled(): boolean
}

class CustomUserDetailsService {
    - userManager: UserManager
    
    + CustomUserDetailsService(userManager: UserManager)
    + loadUserByUsername(username: String): UserDetails
}

interface GrantedAuthority <<interface>> {
    + getAuthority(): String
}

class SimpleGrantedAuthority {
    - authority: String
    
    + SimpleGrantedAuthority(role: String)
    + getAuthority(): String
}

' Permission Validation
class WeblogPermissionValidator {
    + {static} validatePermissions(user: User, weblog: Weblog, requiredAction: String): boolean
    + {static} checkWeblogPermission(user: User, weblog: Weblog, action: String): void
}

' ============================================================
' RELATIONSHIPS
' ============================================================

' Generalization (Inheritance)
WeblogPermission --|> ObjectPermission : <<extends>>
RollerPermission --|> ObjectPermission : <<extends>>
RollerUserDetails ..|> UserDetails : <<implements>>
CustomUserDetailsService ..|> UserDetailsService : <<implements>>
SimpleGrantedAuthority ..|> GrantedAuthority : <<implements>>

' Association
User "1" -- "0..*" WeblogPermission : has permissions >
Weblog "1" -- "0..*" WeblogPermission : grants access >
WeblogPermission "1" --> "1" User : for user
WeblogPermission "1" --> "1" Weblog : on weblog

' Composition
RollerUserDetails *-- "1" User : wraps
RollerUserDetails o-- "0..*" GrantedAuthority : contains

' Dependencies (Manager Usage)
UserManager ..> User : <<manages>>
UserManager ..> WeblogPermission : <<manages>>
UserManager ..> Weblog : <<uses>>

CustomUserDetailsService ..> UserManager : <<uses>>
CustomUserDetailsService ..> RollerUserDetails : <<creates>>
RollerUserDetails ..> SimpleGrantedAuthority : <<creates>>

WeblogPermissionValidator ..> User : <<validates>>
WeblogPermissionValidator ..> Weblog : <<validates>>
WeblogPermissionValidator ..> WeblogPermission : <<checks>>

note top of UserManager
  **Responsibility:**
  - User lifecycle management (CRUD)
  - User authentication and activation
  - Permission granting and revocation
  - Permission queries and validation
  **Design Pattern: Facade**
  Provides unified interface for user 
  and permission management
end note

note right of User
  **Core User Entity**
  - Stores authentication credentials
  - Profile information
  - Localization preferences
  - Account status (enabled/disabled)
  - Activation workflow support
end note

note bottom of ObjectPermission
  **Design Pattern: Strategy Pattern**
  Abstract base for different permission types.
  Uses string-based action encoding for flexibility.
  **Potential Issue:**
  String manipulation for permissions could
  be error-prone. Consider enum-based approach.
end note

note right of WeblogPermission
  **Permission Levels:**
  - EDIT_DRAFT: Drafter role (can create drafts)
  - POST: Editor role (can publish entries)
  - ADMIN: Owner role (full control)
  
  **Hierarchy:**
  ADMIN implies POST implies EDIT_DRAFT
end note

note top of RollerUserDetails
  **Integration with Spring Security**
  Adapts Roller's User model to 
  Spring Security's UserDetails interface.
  Bridges domain model with security framework.
end note

note bottom of CustomUserDetailsService
  **Authentication Integration**
  Loads user from database during login.
  Converts permissions to Spring Security
  GrantedAuthority objects.
end note

@enduml
