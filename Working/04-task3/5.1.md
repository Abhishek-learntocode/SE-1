# Refactoring 5.1: Broken Hierarchy — Replace Inheritance with Composition in WeblogPageRequest

**Project:** Apache Roller Weblogger  
**Target Class:** `WeblogPageRequest`  
**Date:** February 14, 2026  
**Refactoring Type:** Behaviour-Preserving Structural Refactoring (Replace Inheritance with Composition + Extract Method)  

---

## Problem and Resolution Summary

### The Problem

`WeblogPageRequest extends WeblogRequest` but does not override or implement **any** method from its parent class `WeblogRequest`. It uses the parent purely as a field container — inheriting `weblogHandle`, `locale`, `pathInfo`, and `getWeblog()` — while adding 11 new fields, 28 new public methods, and a completely independent 170-line URL parsing constructor. This is a textbook case of **Broken Hierarchy**: the inheritance relationship expresses an IS-A contract that does not exist. `WeblogPageRequest` is not a behavioural specialization of `WeblogRequest` — it is a structurally different request type that happens to need the same base data.

The concrete harm this causes is twofold. First, the class hierarchy is misleading: developers reading the code expect `WeblogPageRequest` to refine or extend `WeblogRequest` behaviour, but it does nothing of the sort. Second, `WeblogPageRequest` is tightly coupled to `WeblogRequest`'s concrete implementation — any change to `WeblogRequest`'s fields, constructor, or protected methods risks breaking `WeblogPageRequest`, even though the two have no shared behavioural contract. Additionally, the 170-line constructor is a monolithic block that is difficult to test and reason about.

### How We Resolved It

We applied **Replace Inheritance with Composition**:

1. Created a new `WeblogRequestContext` interface that captures the common contract (weblog handle, locale, weblog lookup, authentication) used polymorphically across the rendering layer
2. Made `WeblogRequest` implement `WeblogRequestContext` (trivially — it already has all the methods)
3. Changed `WeblogPageRequest` from `extends WeblogRequest` to `implements WeblogRequestContext`, composing a `WeblogRequest` instance internally and delegating through 17 thin delegation methods
4. Extracted the monolithic 170-line constructor into 4 focused private methods: `parsePathInfo()`, `parseRequestParameters()`, `parsePageNumber()`, and `buildCustomParams()`
5. Updated 10 model classes that previously cast to `(WeblogRequest)` to cast to `(WeblogRequestContext)` instead

The `WeblogPreviewRequest extends WeblogPageRequest` subclass continues to work correctly — it still extends `WeblogPageRequest` and all its method overrides (`isValidDestination`, `getAuthenticUser`, `isLoggedIn`, `getWeblogEntry`) apply to the delegation methods in the refactored parent.

### Why This Particular Approach

We chose **Composition + Interface** over alternatives because:

- **Keeping the inheritance** would leave the broken hierarchy smell in place — the IS-A relationship is semantically incorrect
- **Simply removing the inheritance** without an interface would break all 10+ model classes that cast `parsedRequest` from `(WeblogRequest)` to check `instanceof WeblogPageRequest`
- **An abstract base class** was considered but rejected because `WeblogRequest` is concrete and used directly (e.g., `UserDataServlet`)
- **The interface** enables model classes to accept any request type polymorphically without depending on `WeblogRequest`'s concrete implementation

---

## 1. Smell Description

| Attribute | Detail |
|-----------|--------|
| **Smell Name** | Broken Hierarchy |
| **Location** | `app/src/main/java/org/apache/roller/weblogger/ui/rendering/util/WeblogPageRequest.java` |
| **Superclass** | `WeblogRequest` (extends `ParsedRequest`) |

### Metric Evidence

| Metric | Value | Threshold/Concern |
|--------|-------|--------------------|
| WMC (Weighted Method Complexity) | 71 | High for what should be a request parser |
| CBO (Coupling Between Objects) | 15 | Moderate coupling |
| LOC | 443 | Bloated by monolithic constructor |
| Public Methods | 28 | Plus 17 inherited methods never overridden |
| Methods Overridden from SuperType | 0 | **The broken hierarchy indicator** |

**Tool Cross-Verification:**
- **Designite Java** — flagged as Broken Hierarchy: "This type does not implement or override any method from its supertype(s): WeblogRequest"
- **CK Metrics** — WMC=71, CBO=15, LOC=443
- **PMD** — No direct rule, but the class was flagged for excessive method count

### The Hierarchy

```
ParsedRequest (abstract)
├── authenticUser, user, deviceType
├── getAuthenticUser(), isLoggedIn(), getUser(), getDeviceType()
│
└── WeblogRequest
    ├── weblogHandle, locale, pathInfo, weblog
    ├── getWeblogHandle(), getLocale(), getPathInfo(), getWeblog()
    │
    └── WeblogPageRequest  ← BROKEN: overrides ZERO methods
        ├── context, weblogAnchor, weblogPageName, weblogCategoryName,
        │   weblogDate, tags, pageNum, customParams, weblogEntry,
        │   weblogPage, weblogCategory, websitePageHit, otherPageHit
        ├── 28 own public methods
        │
        └── WeblogPreviewRequest  ← VALID: overrides 4 methods
```

### Why This Is a Design Problem

1. **Misleading IS-A contract**: The `extends` keyword promises behavioural subtyping — that `WeblogPageRequest` refines `WeblogRequest`'s contract. But it refines nothing. It only reuses fields.

2. **Fragile base class**: Changes to `WeblogRequest`'s internal structure (field visibility, constructor logic, protected methods) can silently break `WeblogPageRequest`. This coupling is invisible to the type system because there is no overridden method to serve as a documented contract point.

3. **Constructor coupling**: `WeblogPageRequest(HttpServletRequest)` calls `super(request)` to trigger parent parsing, then calls `this.getPathInfo()` (inherited) to continue. This creates a hidden temporal coupling: the parent must parse first, leave the correct remainder in `pathInfo`, and then the child continues. Any change to the parent's parsing order breaks the child.

4. **Testing difficulty**: Cannot test `WeblogPageRequest`'s parsing logic without implicitly testing `WeblogRequest`'s constructor, because they share the same instantiation chain.

5. **Monolithic constructor**: The 170-line constructor mixes URL path parsing, request parameter parsing, page number handling, and custom parameter building in a single block. This violates the Single Responsibility Principle at the method level.

---

## 2. Root Cause Analysis

### Architectural Cause

The original design used inheritance as a code-reuse mechanism rather than as a behavioural subtyping mechanism. `WeblogPageRequest` needed access to `weblogHandle`, `locale`, and `getWeblog()`, and the simplest way to get them was `extends WeblogRequest`. This is the classic "inheritance for convenience" anti-pattern.

### Structural Causes

- **Constructor chaining**: The parent constructor parses the common URL prefix (weblog handle, locale, remaining path), and the child continues parsing the rest. This created a perceived dependency on inheritance.
- **Field reuse**: The parent declared `weblogHandle`, `locale`, `pathInfo` as private fields with getters/setters. Inheritance gave the child "free" access to these.
- **Polymorphic usage**: Model classes received request objects as `WeblogRequest` typed variables and checked `instanceof WeblogPageRequest`. This required `WeblogPageRequest` to be a subtype of `WeblogRequest`.

### Why the Hierarchy Became Broken

As `WeblogPageRequest` evolved, it never needed to change `WeblogRequest`'s behaviour — it only needed `WeblogRequest`'s data. The class added 11 fields, 28 methods, and a 170-line constructor of its own, all orthogonal to the parent's purpose. The inheritance relationship was never the right abstraction — composition was.

---

## 3. Refactoring Strategy

### Techniques Applied

1. **Extract Interface** — Created `WeblogRequestContext` defining the polymorphic contract needed by model classes
2. **Replace Inheritance with Composition** — `WeblogPageRequest` now composes a `WeblogRequest` instance instead of extending it
3. **Add Delegation Methods** — 17 thin delegation methods forward calls to the composed instance
4. **Extract Method** — Monolithic constructor split into 4 focused private methods

### Architectural Goal

Break the broken hierarchy by replacing IS-A with HAS-A, express the polymorphic relationship through an explicit interface, and improve constructor readability through method extraction.

### Why This Approach Preserves Behaviour

Every delegation method is a single-line pass-through that produces the identical return value:

```java
// Example delegation — zero logic transformation
public String getWeblogHandle() { return baseRequest.getWeblogHandle(); }
public Weblog getWeblog() { return baseRequest.getWeblog(); }
```

The constructor creates the same `WeblogRequest` object that the `super(request)` call would have created. The composed instance receives the same `HttpServletRequest`, performs the same parsing, and produces the same `weblogHandle`, `locale`, and `pathInfo` values. The remaining parsing in `WeblogPageRequest` reads `baseRequest.getPathInfo()` instead of `this.getPathInfo()` — semantically identical because `this.getPathInfo()` was inherited from `WeblogRequest` and never overridden.

The method extraction in the constructor is purely structural — the same code runs in the same order, producing the same side effects (setting the same fields to the same values). Each extracted method is `private`, ensuring no external caller can observe the decomposition.

### Why Alternative Approaches Were Rejected

| Alternative | Why Rejected |
|-------------|-------------|
| **Keep inheritance, add overrides** | Would be artificial — there's no natural method to override. Adding dummy overrides (`@Override getWeblog() { return super.getWeblog(); }`) would be worse than the current state because it adds noise without changing the design relationship. |
| **Remove hierarchy entirely (no interface)** | Would break 10+ model classes that cast `parsedRequest` to `(WeblogRequest)` and check `instanceof WeblogPageRequest`. Without an interface-based polymorphic type, these casts cannot compile. |
| **Make `WeblogRequest` abstract** | Would break `UserDataServlet` and other code that instantiates `WeblogRequest` directly. |
| **Move `WeblogPageRequest` to extend `ParsedRequest` directly** | Would require `WeblogPageRequest` to duplicate `WeblogRequest`'s parsing logic (weblog handle extraction, locale detection) instead of composing it. |

---

## 4. Files Created

### 4.1 `WeblogRequestContext.java`

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/ui/rendering/util/WeblogRequestContext.java` |
| **Purpose** | Interface defining the common weblog request contract |
| **Package** | `org.apache.roller.weblogger.ui.rendering.util` (same as `WeblogRequest` and `WeblogPageRequest`) |

**Methods Declared:**

| Method | Return Type | Origin | Description |
|--------|-------------|--------|-------------|
| `getWeblogHandle()` | `String` | `WeblogRequest` | Weblog handle parsed from URL |
| `getLocale()` | `String` | `WeblogRequest` | Locale string from URL |
| `getWeblog()` | `Weblog` | `WeblogRequest` | Lazily loaded Weblog entity |
| `getLocaleInstance()` | `Locale` | `WeblogRequest` | Java Locale from string |
| `getAuthenticUser()` | `String` | `ParsedRequest` | Authenticated user name |
| `getUser()` | `User` | `ParsedRequest` | Lazily loaded User entity |
| `isLoggedIn()` | `boolean` | `ParsedRequest` | Authentication check |

**Design Rationale:** The interface captures the behavioural contract that model classes actually depend on. It includes methods from both `ParsedRequest` (authentication) and `WeblogRequest` (weblog identification) because model classes use both sets of methods through the `WeblogRequest` typed variable. Including only weblog methods would not cover `UtilitiesModel`'s use of `getAuthenticUser()` and `getUser()`.

---

## 5. Files Modified

### 5.1 `WeblogRequest.java`

| Change | Detail |
|--------|--------|
| **Added** | `implements WeblogRequestContext` to class declaration |
| **Lines changed** | 1 line |
| **Impact** | Zero — `WeblogRequest` already has all methods declared in the interface |

The addition is purely declarative. No method bodies change. All 6 existing subclasses (`WeblogFeedRequest`, `WeblogSearchRequest`, `WeblogCommentRequest`, `WeblogTrackbackRequest`, `WeblogResourceRequest`, `WeblogMediaResourceRequest`) automatically satisfy the interface through inheritance.

### 5.2 `WeblogPageRequest.java`

| Change | Detail |
|--------|--------|
| **Class declaration** | `extends WeblogRequest` → `implements WeblogRequestContext` |
| **Added field** | `private final WeblogRequest baseRequest` |
| **Constructor (no-arg)** | Initializes `baseRequest = new WeblogRequest()` |
| **Constructor (HTTP)** | Creates `baseRequest = new WeblogRequest(request)` instead of `super(request)` |
| **Constructor decomposition** | 170-line body split into 4 private methods |
| **Added delegation methods** | 17 thin delegation methods for `WeblogRequest` and `ParsedRequest` methods |
| **Added imports** | `Locale`, `User`, `Weblog`, `MobileDeviceRepository` |

**Constructor Decomposition:**

| Extracted Method | Lines | Responsibility |
|-----------------|-------|---------------|
| `parsePathInfo(String, HttpServletRequest)` | ~80 | Parse URL path for context, anchor, date, category, page, tags |
| `parseRequestParameters(String, HttpServletRequest)` | ~30 | Parse query params (entry, anchor, date, cat) |
| `parsePageNumber(HttpServletRequest)` | ~8 | Parse page number param |
| `buildCustomParams(HttpServletRequest)` | ~8 | Build template-author custom params map |

**Delegation Methods Added:**

| Delegation Method | Delegates To |
|-------------------|-------------|
| `getWeblogHandle()` | `baseRequest.getWeblogHandle()` |
| `setWeblogHandle(String)` | `baseRequest.setWeblogHandle(String)` |
| `getLocale()` | `baseRequest.getLocale()` |
| `setLocale(String)` | `baseRequest.setLocale(String)` |
| `getPathInfo()` | `baseRequest.getPathInfo()` |
| `setPathInfo(String)` | `baseRequest.setPathInfo(String)` |
| `getWeblog()` | `baseRequest.getWeblog()` |
| `setWeblog(Weblog)` | `baseRequest.setWeblog(Weblog)` |
| `getLocaleInstance()` | `baseRequest.getLocaleInstance()` |
| `setLocaleInstance(Locale)` | `baseRequest.setLocaleInstance(Locale)` |
| `getAuthenticUser()` | `baseRequest.getAuthenticUser()` |
| `setAuthenticUser(String)` | `baseRequest.setAuthenticUser(String)` |
| `getUser()` | `baseRequest.getUser()` |
| `setUser(User)` | `baseRequest.setUser(User)` |
| `isLoggedIn()` | `baseRequest.isLoggedIn()` |
| `getDeviceType()` | `baseRequest.getDeviceType()` |
| `setDeviceType(DeviceType)` | `baseRequest.setDeviceType(DeviceType)` |

### 5.3 `WeblogPreviewRequest.java`

| Change | Detail |
|--------|--------|
| **No structural changes** | Still extends `WeblogPageRequest` |
| **Overrides preserved** | `isValidDestination()`, `getAuthenticUser()`, `isLoggedIn()`, `getWeblogEntry()` — all now override delegation methods in `WeblogPageRequest` instead of inherited methods from `ParsedRequest`/`WeblogRequest`, with identical runtime effect |

**Behavioural equivalence of overrides:**
- `getAuthenticUser()` returns `null` — previously overrode `ParsedRequest.getAuthenticUser()`, now overrides `WeblogPageRequest.getAuthenticUser()` (which would delegate to `baseRequest.getAuthenticUser()`). The override prevents the delegation and returns `null` directly. Same result.
- `isLoggedIn()` returns `false` — same pattern.
- `getWeblogEntry()` — overrides `WeblogPageRequest.getWeblogEntry()` — same as before.
- `isValidDestination(String)` — overrides `WeblogPageRequest.isValidDestination()` — same as before.

### 5.4 Model Classes Updated (10 files)

All model classes that cast `initData.get("parsedRequest")` to `(WeblogRequest)` were updated to cast to `(WeblogRequestContext)` instead. The change in each file is minimal:

| File | Change Summary |
|------|---------------|
| `PageModel.java` | Cast `(WeblogRequest)` → `(WeblogRequestContext)`, `weblogRequest.getDeviceType()` → `pageRequest.getDeviceType()` |
| `SiteModel.java` | Field type `WeblogRequest` → `WeblogRequestContext`, cast updated |
| `CalendarModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `MenuModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `PlanetModel.java` | Field type `WeblogRequest` → `WeblogRequestContext`, cast updated |
| `URLModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `MessageModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `PreviewPageModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `PreviewURLModel.java` | Local variable cast `(WeblogRequest)` → `(WeblogRequestContext)` |
| `UtilitiesModel.java` | Field type `ParsedRequest` → `WeblogRequestContext`, init logic updated |

Each file also adds `import org.apache.roller.weblogger.ui.rendering.util.WeblogRequestContext`.

---

## 6. Files NOT Modified (Explicitly Preserved)

| File | Why No Change Needed |
|------|---------------------|
| `FeedModel.java` | Only receives `WeblogFeedRequest` (extends `WeblogRequest implements WeblogRequestContext`) — cast to `(WeblogRequest)` still valid |
| `SearchResultsFeedModel.java` | Same reason as `FeedModel` |
| `UserDataServlet.java` | Creates `new WeblogRequest(request)` directly — no `WeblogPageRequest` involvement |
| `PageServlet.java` | Uses `WeblogPageRequest` as concrete type — no polymorphic casting |
| `SearchServlet.java` | Uses `WeblogPageRequest` as concrete type — no polymorphic casting |
| `WeblogPreviewRequest.java` | No structural change — `extends WeblogPageRequest` continues to work |
| `WeblogPageCache.java` | Takes `WeblogPageRequest` as concrete parameter type |
| `SiteWideCache.java` | Takes `WeblogPageRequest` as concrete parameter type |
| `WeblogCalendarModel.java` | Takes `WeblogPageRequest` as concrete parameter type |
| `BigWeblogCalendarModel.java` | Takes `WeblogPageRequest` as concrete parameter type |

---

## 7. Dependency Graph Change

### Before

```
ParsedRequest (abstract)
└── WeblogRequest (concrete)
    ├── WeblogFeedRequest
    ├── WeblogSearchRequest
    ├── WeblogCommentRequest
    ├── WeblogTrackbackRequest
    ├── WeblogResourceRequest
    ├── WeblogMediaResourceRequest
    └── WeblogPageRequest          ← extends WeblogRequest (BROKEN: overrides nothing)
        └── WeblogPreviewRequest   ← extends WeblogPageRequest (VALID: overrides 4 methods)
```

Model classes: `(WeblogRequest) initData.get("parsedRequest")` → `instanceof WeblogPageRequest`

### After

```
WeblogRequestContext (interface)        ← NEW
├── WeblogRequest implements WeblogRequestContext
│   ├── WeblogFeedRequest
│   ├── WeblogSearchRequest
│   ├── WeblogCommentRequest
│   ├── WeblogTrackbackRequest
│   ├── WeblogResourceRequest
│   └── WeblogMediaResourceRequest
│
└── WeblogPageRequest implements WeblogRequestContext   ← COMPOSITION (composes WeblogRequest)
    └── WeblogPreviewRequest extends WeblogPageRequest  ← UNCHANGED
```

Model classes: `(WeblogRequestContext) initData.get("parsedRequest")` → `instanceof WeblogPageRequest`

**Key structural change:** `WeblogPageRequest` is no longer in the `WeblogRequest` type hierarchy. It expresses its relationship to `WeblogRequest` through composition (HAS-A) rather than inheritance (IS-A). Both types share the `WeblogRequestContext` interface for polymorphic usage.

---

## 8. Metrics Before vs After

### WeblogPageRequest

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **Inheritance depth** | 3 (ParsedRequest → WeblogRequest → WeblogPageRequest) | 1 (implements WeblogRequestContext) | −2 levels |
| **Methods overridden from parent** | 0 | N/A | Smell eliminated |
| **Constructor length** | ~170 lines (monolithic) | ~20 lines + 4 extracted methods | Improved readability |
| **Delegation methods** | 0 | 17 | Explicit composition |
| **LOC** | 443 | ~530 | +87 (delegation + extracted methods — structurally cleaner despite more lines) |
| **WMC** | 71 | ~71 | Unchanged (complexity moved to extracted methods) |
| **CBO** | 15 | ~15 | Unchanged (same dependencies) |

### Model Classes (Aggregate)

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **Coupling to concrete `WeblogRequest`** | 10 model classes | 0 model classes | −100% (now via interface) |
| **Coupling to `WeblogRequestContext` (interface)** | 0 | 10 model classes | Interface-based coupling (looser) |

---

## 9. Build and Test Verification

### Build

```
Command: mvn compile -pl app
Result:  BUILD SUCCESS
```

No compilation errors. No new warnings introduced.

### Test Comparison

| Metric | Before Refactoring | After Refactoring |
|--------|-------------------|-------------------|
| Tests run | 158 | 158 |
| Failures | 0 | 0 |
| Errors | 0 | 0 |
| Skipped | 1 | 1 |
| Build result | SUCCESS | SUCCESS |

```
Command: mvn clean test -pl app
Result:  BUILD SUCCESS
Tests run: 158, Failures: 0, Errors: 0, Skipped: 1
```

Key tests that exercise the refactored code:
- `SearchResultsModelTest` — creates `WeblogPageRequest` with no-arg constructor, passes it as `parsedRequest` to model init
- `SearchResultsFeedModelTest` — verifies feed model initialisation (uses `WeblogFeedRequest extends WeblogRequest implements WeblogRequestContext`)

---

## 10. Behaviour Preservation Justification

| Concern | Why It Is Preserved |
|---------|--------------------|
| **URL parsing** | The `WeblogRequest(request)` constructor is called identically — as `new WeblogRequest(request)` instead of `super(request)`. Same HTTP request, same parsing logic, same resulting `weblogHandle`, `locale`, `pathInfo` values. |
| **Path continuation** | `WeblogPageRequest` reads `baseRequest.getPathInfo()` instead of `this.getPathInfo()`. Before refactoring, `this.getPathInfo()` was inherited from `WeblogRequest` without override — i.e., it was already calling `WeblogRequest.getPathInfo()`. Same result. |
| **Lazy loading** | `getWeblog()`, `getWeblogEntry()`, `getWeblogPage()`, `getWeblogCategory()` all use the same lazy initialization pattern with the same null-check guards. `getWeblog()` delegates to `baseRequest.getWeblog()` which performs the same `WebloggerFactory.getWeblogger().getWeblogManager().getWeblogByHandle()` call. |
| **Authentication** | `getAuthenticUser()`, `isLoggedIn()`, `getUser()` delegate to `baseRequest` which inherits them from `ParsedRequest`. Same `request.getUserPrincipal()` extraction. |
| **WeblogPreviewRequest overrides** | `WeblogPreviewRequest.getAuthenticUser()` returns `null`. Previously overrode `ParsedRequest.getAuthenticUser()`. Now overrides `WeblogPageRequest.getAuthenticUser()`. The override prevents the delegation. Same result: `null`. |
| **Device type** | `getDeviceType()` delegates to `baseRequest.getDeviceType()`. Same `MobileDeviceRepository.getRequestType(request)` extraction. |
| **Model initialization** | Models cast `initData.get("parsedRequest")` to `(WeblogRequestContext)`. Both `WeblogRequest` and `WeblogPageRequest` implement this interface. The cast succeeds for all request types. The subsequent `instanceof WeblogPageRequest` checks still work because the actual runtime type is unchanged. |
| **No-arg constructor** | `new WeblogPageRequest()` creates `baseRequest = new WeblogRequest()` which calls `ParsedRequest()`. Same empty initialization as before. `SearchServlet` and tests that use this constructor continue to work by calling setters (`setWeblogHandle`, `setLocale`, etc.) which delegate to `baseRequest`. |
| **Exception semantics** | Constructor throws `InvalidRequestException` at exactly the same points (invalid servlet, invalid date, missing path elements). The extracted methods propagate exceptions without catching or wrapping them. |
| **Template resolution** | `getWeblogPage()` calls `getWeblog().getTheme().getTemplateByLink(weblogPageName)` — `getWeblog()` returns the same Weblog. Same template resolution. |

**Empirical proof:** Full test suite (158 tests) passes identically before and after refactoring.

---

## 11. Design Decisions and Constraints

### Why `WeblogRequestContext` Interface Was Introduced

The interface serves two purposes:

1. **Polymorphic replacement**: Model classes (10 files) previously received the parsed request as a `WeblogRequest` typed variable. After removing inheritance, `WeblogPageRequest` is no longer a `WeblogRequest`. The interface provides a common supertype for both.

2. **Documented contract**: The interface makes explicit which methods models actually depend on. Before, models could access any `WeblogRequest` or `ParsedRequest` method through the inheritance chain. Now, they can only access methods declared in `WeblogRequestContext`.

### Why the Interface Includes Authentication Methods

The `UtilitiesModel` class stores the parsed request as `ParsedRequest` and later calls `parsedRequest.getAuthenticUser()` and `parsedRequest.getUser()`. Since `WeblogPageRequest` no longer extends `ParsedRequest`, the interface must include these methods to maintain `UtilitiesModel`'s functionality.

### Why `WeblogPreviewRequest` Did Not Require Changes

`WeblogPreviewRequest extends WeblogPageRequest` — this inheritance relationship is **valid** (it overrides 4 methods). The overridden methods are now on `WeblogPageRequest` (delegation methods and `isValidDestination`/`getWeblogEntry`), not on `ParsedRequest`/`WeblogRequest`. Java's override resolution works identically: the override in the subclass takes precedence regardless of whether the parent method is inherited or defined directly. The `@Override` annotations compile correctly.

### What Was Intentionally Not Changed

| Element | Why Untouched |
|---------|---------------|
| `WeblogRequest` class | Only added `implements WeblogRequestContext` — no method changes |
| `WeblogPreviewRequest` | Valid hierarchy — `extends WeblogPageRequest` with real overrides |
| `FeedModel`, `SearchResultsFeedModel` | Only receive `WeblogFeedRequest` objects — `(WeblogRequest)` cast still valid |
| `PageServlet`, `SearchServlet` | Use `WeblogPageRequest` as concrete type — no polymorphic casting |
| Cache classes, calendar models | Take `WeblogPageRequest` as concrete parameter — no change needed |

---

## 12. Architectural Impact

### Before

```
Model classes → cast to (WeblogRequest) → instanceof WeblogPageRequest → cast
                  ↑
   Tight coupling to concrete WeblogRequest class
   WeblogPageRequest inherits but never overrides — broken contract
```

Every model class was coupled to `WeblogRequest`'s concrete type. The inheritance relationship between `WeblogPageRequest` and `WeblogRequest` communicated a false IS-A contract. Developers maintaining these classes had to understand a 3-level inheritance hierarchy (`ParsedRequest` → `WeblogRequest` → `WeblogPageRequest`) to trace method resolution.

### After

```
Model classes → cast to (WeblogRequestContext) → instanceof WeblogPageRequest → cast
                  ↑
   Coupling via interface (loose, contractual)
   WeblogPageRequest composes WeblogRequest — explicit HAS-A
```

Model classes now depend on an interface rather than a concrete class. The relationship between `WeblogPageRequest` and `WeblogRequest` is explicit composition — developers can see the `baseRequest` field and the delegation methods. There is no hidden inheritance chain to trace.

---

## 13. Future Extensibility Benefits

1. **New request types**: Any new request type can implement `WeblogRequestContext` without being forced into the `WeblogRequest` class hierarchy. For example, an `APIRequest` class could implement the interface with entirely different internal structure.

2. **Model decoupling**: Models that currently check `instanceof WeblogPageRequest` could be further refactored to check interface capabilities instead of concrete types. The interface enables gradual migration toward composition-based model initialization.

3. **Testability**: `WeblogPageRequest` can now be tested with a mock `WeblogRequest` injected as `baseRequest`, isolating the page-specific URL parsing from the base request parsing. The extracted constructor methods can be tested independently.

4. **Independent evolution**: `WeblogRequest` and `WeblogPageRequest` can now evolve independently. Changes to `WeblogRequest`'s internals (e.g., switching from manual URL parsing to a URL library) only affect `WeblogPageRequest` through the stable getter/setter interface, not through inherited implementation details.

---

## 14. Limitations and Tradeoffs

| Limitation | Description | Why Acceptable |
|------------|-------------|----------------|
| **Increased LOC** | `WeblogPageRequest` grows by ~87 lines (17 delegation methods) | Delegation methods are trivial one-liners. The LOC increase is mechanical, not complexity-increasing. Each method is independently readable. |
| **Indirect access** | Method calls go through one additional delegation hop | The JVM inlines single-delegation methods. No measurable performance impact in a web application. |
| **Interface breadth** | `WeblogRequestContext` has 7 methods including authentication | Captures the actual usage pattern in model classes. A narrower interface would not cover `UtilitiesModel`'s needs. |
| **Dual construction** | `WeblogPageRequest` creates `new WeblogRequest(request)` which creates its own internal `ParsedRequest` — the `ParsedRequest` state on `WeblogPageRequest`'s composed `WeblogRequest` handles auth/device type | This is the natural consequence of composition. The composed `WeblogRequest` is a self-contained object. |
| **10 model files touched** | Casting changes in 10 model classes | Each change is a minimal import addition + variable type change. No logic modification. |

---

## 15. Summary of All Changes

| File | Type | Change |
|------|------|--------|
| `WeblogRequestContext.java` | **New** | Interface with 7 methods |
| `WeblogRequest.java` | Modified | Added `implements WeblogRequestContext` (1 line) |
| `WeblogPageRequest.java` | Modified | Composition, delegation, constructor extraction |
| `PageModel.java` | Modified | Cast `(WeblogRequestContext)`, use `pageRequest.getDeviceType()` |
| `SiteModel.java` | Modified | Field type + cast to `WeblogRequestContext` |
| `CalendarModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `MenuModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `PlanetModel.java` | Modified | Field type + cast to `WeblogRequestContext` |
| `URLModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `MessageModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `PreviewPageModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `PreviewURLModel.java` | Modified | Cast to `(WeblogRequestContext)` |
| `UtilitiesModel.java` | Modified | Field type `ParsedRequest` → `WeblogRequestContext`, init logic |

**Total: 1 new file, 12 modified files. 0 deleted files.**
