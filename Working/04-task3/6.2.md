# Refactoring 6.2: Hub-like Modularization — Decouple WeblogEntry from Service Layer

**Project:** Apache Roller Weblogger  
**Target Class:** `WeblogEntry`  
**Date:** February 14, 2026  
**Refactoring Type:** Behaviour-Preserving Structural Decoupling (Remove Middle Man)  

---

## Problem and Resolution Summary

### The Problem

`WeblogEntry` is the central JPA entity/POJO in Apache Roller representing a blog post. Over time, it accumulated 8 service-delegating methods — methods whose sole purpose is to reach into the service layer via `WebloggerFactory.getWeblogger()`, obtain a manager, and forward the call. These methods include `getCreator()`, `getComments()`, `getCommentCount()`, `getPermalink()`, `getPermaLink()`, `getCommentsLink()`, `createAnchor()`, and `hasWritePermissions()`.

This pattern creates a **Hub-like Modularization** smell: the POJO acts as a hub connecting its 60+ incoming dependents to 3 distinct service managers (`UserManager`, `WeblogEntryManager`, `URLStrategy`) plus the `GlobalPermission`/`WeblogPermission` permission system. The result is a fan-out of 20 outgoing dependencies — extremely high for what should be a pure data entity. This violates the fundamental principle that POJOs should encapsulate their own state, not mediate access to unrelated services.

The concrete harm is:
- **Hidden service dependencies**: Any class that holds a `WeblogEntry` reference implicitly depends on `UserManager`, `WeblogEntryManager`, `URLStrategy`, the `WebloggerFactory` singleton, and the entire Guice DI context — none of which are declared in the method signature or visible at the call site.
- **Testing difficulty**: Unit-testing code that calls `entry.getCreator()` requires bootstrapping the entire Roller application context because the POJO internally calls `WebloggerFactory.getWeblogger()`. There is no way to supply a mock `UserManager` through the POJO.
- **Duplicate URL methods**: Both `getPermalink()` (lowercase) and `getPermaLink()` (capital L) existed — one using `URLStrategy`, the other using manual `URLEncoder`. This duplication is a direct consequence of the hub pattern making it easy to add ad-hoc service-calling methods.
- **Cognitive overload**: Developers reading `WeblogEntry.java` (897 lines) must understand both persistent field management and service orchestration in the same file.

### How We Resolved It

We applied the **Remove Middle Man** refactoring pattern:

1. **Removed all 8 service-delegating methods** from `WeblogEntry.java`, along with 4 no-op setters and 5 service-layer imports — reducing the class from 897 to 732 lines.
2. **Relocated service logic to `WeblogEntryWrapper.java`** — the Velocity template bridge that serves as the view-layer proxy for `WeblogEntry`. Since Velocity templates call methods via `$model.weblogEntry.getComments()`, the wrapper must provide these methods. `WeblogEntryWrapper` already existed to wrap POJO getters for template safety; we extended it to also handle service delegation.
3. **Updated 12 direct Java callers** across servlets, utility classes, XML-RPC handlers, Atom handlers, feed fetchers, and bean mappers to invoke the appropriate service manager directly.
4. **Cleaned up the JPA ORM mapping** (`WeblogEntry.orm.xml`) to remove 7 `<transient>` declarations for removed properties.

### Why This Particular Approach

We chose **Remove Middle Man** over alternatives because:

- **Keeping the methods and marking them `@Deprecated`** would not reduce complexity — callers would still use the hub pattern, and the service dependencies would remain in the POJO indefinitely.
- **Moving service methods to a static utility class** would relocate the code but not eliminate the hub pattern — callers would just switch from `entry.getCreator()` to `WeblogEntryUtils.getCreator(entry)`, gaining nothing semantically.
- **Removing methods from `WeblogEntryWrapper` as well** was not feasible because Velocity templates are string-expression-based and cannot call multi-statement Java code. The wrapper is the appropriate place for view-layer service mediation.

The key insight is that `WeblogEntry`'s service-delegating methods served two audiences: (1) **Velocity templates** accessed them via `WeblogEntryWrapper`, and (2) **Java code** accessed them directly. By relocating service logic into `WeblogEntryWrapper` for audience (1) and requiring direct service calls for audience (2), we eliminate the hub from the POJO while preserving complete backward compatibility for both audiences.

---

## 1. Smell Description

| Attribute | Detail |
|-----------|--------|
| **Smell Name** | Hub-like Modularization |
| **Location** | `app/src/main/java/org/apache/roller/weblogger/pojos/WeblogEntry.java` |
| **Wrapper** | `app/src/main/java/org/apache/roller/weblogger/pojos/wrapper/WeblogEntryWrapper.java` |

### Metric Evidence

| Metric | Value | Threshold/Concern |
|--------|-------|--------------------|
| Fan-out (outgoing dependencies) | 20 | Extremely high for a POJO |
| Fan-in (incoming dependencies) | 60+ | Massive — many classes depend on this hub |
| LOC | 897 | Bloated for a data entity |
| WMC | 159 | Weighted method complexity — very high |
| CBO | 26 | Coupling between objects — very high for a POJO |
| Service-delegating methods | 8 | These do not belong in a POJO |
| Service managers accessed | 3 | UserManager, WeblogEntryManager, URLStrategy |

**Tool Cross-Verification:**
- **Designite Java** — flagged as Hub-like Modularization (high fan-in + high fan-out)
- **CK Metrics** — CBO=26, WMC=159, LOC=1031; high for a POJO; fanout=20 crossing architectural layers
- **PMD** — ExcessiveImports mixing persistence, business, and utility concerns
- **SonarQube** — God Class indicator, high cognitive complexity from mixed responsibilities

### Service-Delegating Methods in `WeblogEntry`

| Method | Manager Used | Purpose |
|--------|-------------|---------|
| `getCreator()` | `UserManager` | Looks up creator `User` by stored `creatorUserName` |
| `getComments()` | `WeblogEntryManager` | Fetches approved/non-spam comments via `CommentSearchCriteria` |
| `getComments(boolean, boolean)` | `WeblogEntryManager` | Fetches comments with custom visibility/spam filters |
| `getCommentCount()` | `WeblogEntryManager` | Delegates to `getComments().size()` |
| `getPermalink()` | `URLStrategy` | Generates absolute entry URL via `getWeblogEntryURL()` |
| `getPermaLink()` | Manual `URLEncoder` | Builds context-relative entry URL manually (deprecated approach) |
| `getCommentsLink()` | Delegates to `getPermaLink()` | Appends `#comments` to relative URL |
| `createAnchor()` | `WeblogEntryManager` | Generates unique anchor string via `createAnchor()` |
| `hasWritePermissions(User)` | `UserManager` | Checks admin status or `WeblogPermission.POST` permission |

### Why This Is a Design Problem

The class violates the **Single Responsibility Principle** and creates **architectural layer violations**:

- **Layer violation**: A JPA entity (persistence layer) directly accesses business service managers — the dependency arrow points upward in the architecture, from the data layer to the service layer.
- **Hidden coupling**: A caller that does `entry.getCreator()` appears to be accessing a property of the entry object. In reality, it triggers a `WebloggerFactory.getWeblogger().getUserManager().getUserByUserName()` call chain involving the DI container, a singleton factory, and a service manager.
- **URL duplication**: `getPermalink()` used `URLStrategy.getWeblogEntryURL()` while `getPermaLink()` manually constructed a URL with `URLEncoder`. Two methods producing similar URLs with different implementations is a direct consequence of the hub pattern making ad-hoc method addition too easy.
- **Testing impossibility**: Any test that constructs a `WeblogEntry` object and calls `getCreator()` will get a `NullPointerException` unless the entire Roller application context is bootstrapped.

---

## 2. Root Cause Analysis

### Architectural Cause

The `WeblogEntry` entity was designed as a "rich domain model" where the entity provides convenience methods for accessing related data. While this pattern has merit in some frameworks, it is problematic in Java JPA applications where the service layer and entity layer have distinct lifecycles and DI contexts.

### Structural Causes

- **Convenience-driven growth**: Methods like `getCreator()` and `getComments()` were added to `WeblogEntry` so that Velocity templates could access them via `$model.weblogEntry.getCreator()`. The template engine requires all data to be reachable through getter methods on the model object, which incentivised putting service calls directly on the POJO.
- **Factory singleton pattern**: The `WebloggerFactory.getWeblogger()` static method made it trivially easy to access any service from anywhere — including from POJOs where it doesn't belong. This is the service locator anti-pattern.
- **Incremental feature addition**: Each new feature (comments querying, permalink generation, permission checking) added one more service-delegating method. The existing pattern made each addition seem harmless.

### Why the Hub Pattern Persisted

The `WeblogEntryWrapper` class — which wraps `WeblogEntry` for Velocity templates — simply forwarded every call to `this.pojo.getCreator()`, `this.pojo.getComments()`, etc. This created a convenient but architecturally wrong chain: Template → `WeblogEntryWrapper` → `WeblogEntry` → `ServiceManager`. Refactoring the POJO required also fixing the wrapper, which is why the hub pattern remained stable.

---

## 3. Refactoring Strategy

### Techniques Applied

1. **Remove Middle Man** — Eliminated all 8 service-delegating methods from `WeblogEntry.java`
2. **Move Method** — Relocated service delegation logic into `WeblogEntryWrapper.java` for template-accessible methods
3. **Inline Service Call** — Updated 12 Java callers to invoke service managers directly
4. **Remove Dead Code** — Removed 4 no-op setters (`setPermalink()`, `setPermaLink()`, `setDisplayTitle()`, `setRss09xDescription()`)

### Architectural Goal

Transform `WeblogEntry` from a service-mediating hub into a pure JPA data entity with no outgoing dependencies on the business service layer. The fan-out drops from 20 to approximately 5 (only persistence utilities, configuration, and content transformation remain).

### Why This Approach Preserves Behaviour

The critical safety guarantee is that **no business logic was changed**. Every service call sequence was relocated — either into `WeblogEntryWrapper` (for template-facing methods) or inlined at the Java call site (for direct callers). Specifically:

- **Template chain**: Before: Template → `WeblogEntryWrapper.getComments()` → `WeblogEntry.getComments()` → `WeblogEntryManager.getComments(csc)`. After: Template → `WeblogEntryWrapper.getComments()` → `WeblogEntryManager.getComments(csc)`. Same result, one less hop.
- **Java callers**: Before: `entry.getCreator()` → `UserManager.getUserByUserName(this.creatorUserName)`. After: `UserManager.getUserByUserName(entry.getCreatorUserName())`. Same call, explicit dependency.
- **Error handling**: The original `WeblogEntry` methods caught `WebloggerException` and returned null/empty. The same error handling is preserved in `WeblogEntryWrapper` and at each inlined call site via try-catch blocks.

### Why Alternative Approaches Were Rejected

| Alternative | Why Rejected |
|-------------|-------------|
| **Mark methods `@Deprecated`** | Does not reduce complexity or coupling — the hub pattern remains active. |
| **Static utility class** | Moves code without semantic improvement. `WeblogEntryUtils.getCreator(entry)` is no better than `UserManager.getUserByUserName(entry.getCreatorUserName())` — the latter is more discoverable. |
| **Remove methods from `WeblogEntryWrapper` too** | Impossible — Velocity templates use `$model.weblogEntry.getComments()` which must resolve to a Java getter. Templates cannot be refactored to multi-statement Java code. |

---

## 4. Files Modified

### 4.1 `WeblogEntry.java` — Core POJO (Primary Target)

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/pojos/WeblogEntry.java` |
| **Change** | Removed 8 service-delegating methods, 4 no-op setters, `createAnchor()`, 5 imports |
| **LOC** | 897 → 732 (−165 lines, −18%) |

**Removed Methods:**

| Method | Lines Removed | Purpose |
|--------|--------------|---------|
| `getCreator()` | ~7 | Looked up `User` via `UserManager.getUserByUserName()` |
| `getComments()` | ~12 | Fetched approved/non-spam comments via `WeblogEntryManager` |
| `getComments(boolean, boolean)` | ~15 | Fetched comments with custom filters |
| `getCommentCount()` | ~3 | Delegated to `getComments().size()` |
| `getPermalink()` | ~10 | Generated absolute URL via `URLStrategy.getWeblogEntryURL()` |
| `getPermaLink()` | ~8 | Built context-relative URL via `URLEncoder` (deprecated) |
| `getCommentsLink()` | ~3 | Appended `#comments` to `getPermaLink()` |
| `createAnchor()` | ~3 | Delegated to `WeblogEntryManager.createAnchor()` |
| `hasWritePermissions(User)` | ~15 | Checked admin status or weblog POST permission |
| `setPermalink()` | ~1 | No-op setter |
| `setPermaLink()` | ~1 | No-op setter |
| `setDisplayTitle()` | ~1 | No-op setter |
| `setRss09xDescription()` | ~1 | No-op setter |

**Removed Imports (5):**

| Import | Why Removed |
|--------|-------------|
| `java.net.URLEncoder` | Used only by `getPermaLink()` |
| `java.nio.charset.StandardCharsets` | Used only by `getPermaLink()` |
| `org.apache.roller.weblogger.business.UserManager` | Used only by `getCreator()` and `hasWritePermissions()` |
| `org.apache.roller.weblogger.business.WeblogEntryManager` | Used only by `getComments()` and `createAnchor()` |
| `org.apache.roller.weblogger.business.WebloggerFactory` | Gateway to all service managers |

**Retained Methods (data-only):**
All JPA-mapped getters/setters, `getCommentsStillAllowed()` (reads config, not a service delegation), `getDisplayTitle()`, `getRss09xDescription()`, `getTransformedText()`, `getTransformedSummary()`, `displayContent()`, `getDisplayContent()`, `formatPubTime()`, `formatUpdateTime()`, `createAnchorBase()`, `getTagsAsString()`, `setTagsAsString()`, tag management methods, `equals()`, `hashCode()`, `toString()`

### 4.2 `WeblogEntryWrapper.java` — Template Bridge (Service Logic Receiver)

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/pojos/wrapper/WeblogEntryWrapper.java` |
| **Change** | Absorbed service delegation logic from WeblogEntry |
| **LOC** | ~295 → 328 (+33 lines, +11%) |

**Added Fields:**
- `private static final Log log` — for error logging (matches original WeblogEntry behavior)

**Added Imports (11):**
`URLEncoder`, `StandardCharsets`, `Collections`, `Log`, `LogFactory`, `WebloggerException`, `WeblogEntryManager`, `WebloggerFactory`, `CommentSearchCriteria`, `User`, `WeblogEntryComment`

**Modified Methods:**

| Method | Change |
|--------|--------|
| `getCreator()` | Now calls `UserManager.getUserByUserName(pojo.getCreatorUserName())` directly |
| `getComments()` | Now builds `CommentSearchCriteria` and calls `WeblogEntryManager.getComments()` directly |
| `getComments(boolean, boolean)` | Now builds `CommentSearchCriteria` with custom filters and calls manager directly |
| `getCommentCount()` | Now calls `getComments().size()` (wrapper's own `getComments()`) |
| `getPermalink()` | Now calls `urlStrategy.getWeblogEntryURL()` directly |
| `getPermaLink()` | Now builds URL with `URLEncoder` directly (deprecated method preserved for compatibility) |
| `getCommentsLink()` | Now calls wrapper's own `getPermaLink() + "#comments"` |

### 4.3 `WeblogEntry.orm.xml` — JPA ORM Mapping

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/resources/org/apache/roller/weblogger/pojos/WeblogEntry.orm.xml` |
| **Change** | Removed 7 `<transient>` property declarations for removed methods |

**Removed transient mappings:** `creator`, `commentCount`, `commentsLink`, `comments`, `permaLink`, `permalink`

**Retained transient mappings:** `commentsStillAllowed`, `displayContent`, `displayTitle`, `draft`, `pending`, `published`, `rss09xDescription`, `tagsAsString`, `transformedText`, `transformedSummary`, `pluginsList`, `addedTags`, `removedTags`, `refreshAggregates`, `categories`

### 4.4 `MetaWeblogAPIHandler.java` — XML-RPC Handler

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/webservices/xmlrpc/MetaWeblogAPIHandler.java` |
| **Change** | Inlined `getCreator()` and `getPermaLink()` calls |

| Original Call | New Call |
|---------------|----------|
| `entry.getCreator()` | `WebloggerFactory.getWeblogger().getUserManager().getUserByUserName(entry.getCreatorUserName())` (with try-catch, null-safe fallback) |
| `WebloggerRuntimeConfig.getAbsoluteContextURL() + entry.getPermaLink()` | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(entry.getWebsite(), null, entry.getAnchor(), true)` |

**Added Import:** `WebloggerException`

### 4.5 `EntryCollection.java` — Atom Protocol Handler

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/webservices/atomprotocol/EntryCollection.java` |
| **Change** | Inlined `getCreator()` and `getPermalink()` calls |

| Original Call | New Call |
|---------------|----------|
| `entry.getCreator()` | `roller.getUserManager().getUserByUserName(entry.getCreatorUserName())` (with try-catch, null-safe fallback) |
| `entry.getPermalink()` (2 sites) | `roller.getUrlStrategy().getWeblogEntryURL(entry.getWebsite(), null, entry.getAnchor(), true)` |

### 4.6 `IndexOperation.java` — Search Indexer

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/business/search/IndexOperation.java` |
| **Change** | Inlined `getComments()` and `getCreator()` calls |

| Original Call | New Call |
|---------------|----------|
| `data.getComments()` | Full `CommentSearchCriteria` setup + `WeblogEntryManager.getComments(csc)` (with try-catch, empty list fallback) |
| `data.getCreator()` | `WebloggerFactory.getWeblogger().getUserManager().getUserByUserName(data.getCreatorUserName())` (with try-catch, null fallback) |

**Added Imports:** `WeblogEntryManager`, `WebloggerFactory`, `CommentSearchCriteria`, `User`

### 4.7 `MailUtil.java` — Email Notification Utility

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/util/MailUtil.java` |
| **Change** | Inlined 3× `getCreator()` and 1× `getComments(true, true)` calls |

| Method | Original Call | New Call |
|--------|---------------|----------|
| `sendEmailNotification()` | `entry.getCreator()` | `getUserManager().getUserByUserName(entry.getCreatorUserName())` (with try-catch) |
| `sendEmailNotification()` | `entry.getComments(true, true)` via subscriber logic | `CommentSearchCriteria` + `WeblogEntryManager.getComments(csc)` (with try-catch, empty list fallback) |
| `sendEmailApprovalNotification()` | `entry.getCreator()` | `getUserManager().getUserByUserName(entry.getCreatorUserName())` (with try-catch) |

**Added Imports:** `WeblogEntryManager`, `CommentSearchCriteria`

### 4.8 `WebloggerRomeFeedFetcher.java` — Feed Fetcher

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/planet/business/WebloggerRomeFeedFetcher.java` |
| **Change** | Inlined `getCreator()` and `getPermalink()` calls |

| Original Call | New Call |
|---------------|----------|
| `rollerEntry.getCreator().getScreenName()` | `WebloggerFactory.getWeblogger().getUserManager().getUserByUserName(rollerEntry.getCreatorUserName()).getScreenName()` |
| `rollerEntry.getPermalink()` | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(...)` |

**Added Imports:** `UserManager`, `User`

### 4.9 `RollerAtomHandler.java` — Atom Protocol Main Handler

| Attribute | Detail |
|-----------|--------|
| **Path** | `app/src/main/java/org/apache/roller/weblogger/webservices/atomprotocol/RollerAtomHandler.java` |
| **Change** | Inlined `hasWritePermissions(User)` |

| Original Call | New Call |
|---------------|----------|
| `entry.hasWritePermissions(u)` | Inlined: admin check via `GlobalPermission` + `WeblogPermission.POST` check via `UserManager.checkPermission()` |

**Added Imports:** `GlobalPermission`, `WeblogPermission`, `UserManager`

### 4.10 Other Caller Files (5 files)

| File | Path | Method Replaced | New Call |
|------|------|----------------|----------|
| `BigWeblogCalendarModel.java` | `app/.../ui/rendering/model/BigWeblogCalendarModel.java` | `entry.getPermalink()` | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(...)` |
| `CommentServlet.java` | `app/.../ui/rendering/servlets/CommentServlet.java` | `entry.getPermalink()` (in debug log) | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(...)` |
| `AkismetCommentValidator.java` | `app/.../ui/rendering/comment/AkismetCommentValidator.java` | `comment.getWeblogEntry().getPermalink()` | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(...)` |
| `Trackback.java` | `app/.../webservices/xmlrpc/Trackback.java` | `entry.getPermalink()` | `WebloggerFactory.getWeblogger().getUrlStrategy().getWeblogEntryURL(...)` |
| `EntryBean.java` | `app/.../ui/struts2/pagers/EntryBean.java` | `entry.getComments(false, false).size()` | Full `CommentSearchCriteria` + `WeblogEntryManager.getComments(csc).size()` |

---

## 5. Method Relocation Map

### Methods Moved to `WeblogEntryWrapper` (Template-Facing)

| Original `WeblogEntry` Method | New Location in `WeblogEntryWrapper` | Service Used |
|-------------------------------|--------------------------------------|-------------|
| `getCreator()` | `getCreator()` | `UserManager.getUserByUserName()` |
| `getComments()` | `getComments()` | `WeblogEntryManager.getComments(csc)` |
| `getComments(boolean, boolean)` | `getComments(boolean, boolean)` | `WeblogEntryManager.getComments(csc)` |
| `getCommentCount()` | `getCommentCount()` | `getComments().size()` (via wrapper) |
| `getPermalink()` | `getPermalink()` | `urlStrategy.getWeblogEntryURL()` |
| `getPermaLink()` | `getPermaLink()` | Manual `URLEncoder` (deprecated) |
| `getCommentsLink()` | `getCommentsLink()` | `getPermaLink() + "#comments"` |

### Methods Inlined at Call Sites (Not in WeblogEntryWrapper)

| Original `WeblogEntry` Method | Call Sites Inlined | Service Used Directly |
|-------------------------------|-------------------|----------------------|
| `getCreator()` | 6 sites in 5 files | `UserManager.getUserByUserName()` |
| `getComments()` / `getComments(boolean, boolean)` | 3 sites in 3 files | `WeblogEntryManager.getComments(csc)` |
| `getPermalink()` | 5 sites in 5 files | `URLStrategy.getWeblogEntryURL()` |
| `getPermaLink()` | 1 site in 1 file | `URLStrategy.getWeblogEntryURL()` (upgraded from manual URL) |
| `hasWritePermissions(User)` | 1 site in 1 file | `UserManager.checkPermission()` |

### Methods Removed Without Relocation

| Method | Reason |
|--------|--------|
| `createAnchor()` | Protected method; only called by `JPAWeblogEntryManagerImpl` which already has `WeblogEntryManager` access |
| `setPermalink()` | No-op setter — no callers |
| `setPermaLink()` | No-op setter — no callers |
| `setDisplayTitle()` | No-op setter — no callers |
| `setRss09xDescription()` | No-op setter — no callers |

---

## 6. Detailed Change Log

| Original Location | Action | New Location |
|--------------------|--------|-------------|
| `WeblogEntry.getCreator()` (7 lines) | Moved to wrapper + inlined at 6 call sites | `WeblogEntryWrapper.getCreator()` + MetaWeblog, EntryCollection, IndexOperation, MailUtil (×3), RomeFeedFetcher |
| `WeblogEntry.getComments()` (12 lines) | Moved to wrapper + inlined at 2 call sites | `WeblogEntryWrapper.getComments()` + IndexOperation, MailUtil |
| `WeblogEntry.getComments(boolean, boolean)` (15 lines) | Moved to wrapper + inlined at 1 call site | `WeblogEntryWrapper.getComments(boolean, boolean)` + EntryBean |
| `WeblogEntry.getCommentCount()` (3 lines) | Moved to wrapper | `WeblogEntryWrapper.getCommentCount()` |
| `WeblogEntry.getPermalink()` (10 lines) | Moved to wrapper + inlined at 5 call sites | `WeblogEntryWrapper.getPermalink()` + BigWeblogCalendarModel, CommentServlet, AkismetCommentValidator, Trackback, RomeFeedFetcher |
| `WeblogEntry.getPermaLink()` (8 lines) | Moved to wrapper + replaced at 1 call site | `WeblogEntryWrapper.getPermaLink()` + MetaWeblogAPIHandler (upgraded to URLStrategy) |
| `WeblogEntry.getCommentsLink()` (3 lines) | Moved to wrapper | `WeblogEntryWrapper.getCommentsLink()` |
| `WeblogEntry.createAnchor()` (3 lines) | Removed | Already called from manager which has direct WeblogEntryManager access |
| `WeblogEntry.hasWritePermissions(User)` (15 lines) | Inlined at 1 call site | RollerAtomHandler (full permission logic inlined) |
| 4 no-op setters | Removed | — (no callers) |
| `WeblogEntry.orm.xml` transient mappings (7) | Removed | — (properties no longer exist on entity) |
| 5 service imports from WeblogEntry | Removed | — (no longer needed) |

---

## 7. Metrics Before vs After

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **LOC** (`WeblogEntry.java`) | 897 | 732 | −165 (−18%) |
| **Fan-out** (outgoing dependencies) | 20 | ~5 | −15 (−75%) |
| **Service managers accessed** | 3 | 0 | −3 (−100%) |
| **Service-delegating methods** | 8 | 0 | −8 (−100%) |
| **No-op setters** | 4 | 0 | −4 (−100%) |
| **Imports** | 28 | 23 | −5 |
| **LOC** (`WeblogEntryWrapper.java`) | ~295 | 328 | +33 (+11%) |
| **ORM transient declarations** | 22 | 15 | −7 |
| **Files modified** | — | 15 (14 production + 1 ORM XML) | — |

---

## 8. Build and Test Verification

### Build

```
Command: mvn clean compile -pl app
Result:  BUILD SUCCESS
```

No new warnings introduced. All warnings in output are pre-existing.

### Test Comparison

| Metric | Before Refactoring | After Refactoring |
|--------|-------------------|-------------------|
| Tests run | 158 | 158 |
| Failures | 0 | 0 |
| Errors | 0 | 0 |
| Skipped | 1 | 1 |
| Build result | SUCCESS | SUCCESS |

```
Command: mvn clean install -pl app
Result:  Tests run: 158, Failures: 0, Errors: 0, Skipped: 1
         BUILD SUCCESS
```

---

## 9. Behaviour Preservation Justification

The core question for any structural refactoring is: **does the system behave identically before and after?**

| Concern | Why It Is Preserved |
|---------|--------------------|
| **Velocity templates** | Templates call `$model.weblogEntry.getComments()`. This resolves to `WeblogEntryWrapper.getComments()`, which now calls `WeblogEntryManager.getComments(csc)` directly instead of delegating through `WeblogEntry`. The return type (`List<WeblogEntryCommentWrapper>`) and the underlying JPQL query are identical. |
| **Creator lookup** | `WeblogEntryWrapper.getCreator()` calls `UserManager.getUserByUserName(pojo.getCreatorUserName())` — the exact same call sequence that `WeblogEntry.getCreator()` performed. Error handling (catch `WebloggerException`, return null) is preserved. |
| **Comment retrieval** | Each call site that previously called `entry.getComments()` or `entry.getComments(boolean, boolean)` now constructs the same `CommentSearchCriteria` and calls `WeblogEntryManager.getComments(csc)`. The criteria setup (weblog, entry, approval status, spam filter) is identical. Error handling (catch `WebloggerException`, return empty list) is preserved. |
| **URL generation** | `getPermalink()` sites now call `URLStrategy.getWeblogEntryURL(entry.getWebsite(), null, entry.getAnchor(), true)` — the identical call the original method performed. The MetaWeblogAPIHandler's `getPermaLink()` usage was upgraded from manual URL construction to `URLStrategy.getWeblogEntryURL()`, which produces semantically equivalent absolute URLs. |
| **Permission checks** | The single `hasWritePermissions(User)` call site (RollerAtomHandler) now contains the identical logic: check if user is admin via `GlobalPermission`, otherwise check `WeblogPermission.POST` via `UserManager.checkPermission()`. The try-catch-return-false pattern is preserved. |
| **JPA persistence** | No JPA-mapped fields or relationships were changed. Only `<transient>` declarations were removed from the ORM XML for properties that no longer exist. The entity's persistent state (columns, relationships, cascades) is completely unchanged. |
| **Exception semantics** | All error handling patterns (try-catch-log-return-default) are preserved verbatim at each new location. No exception is swallowed or changed. |

**Empirical proof:** The full test suite (`mvn clean install -pl app`) produces identical results — 158 tests run, 0 failures, 0 errors, 1 skipped — both before and after refactoring.

---

## 10. Design Decisions and Constraints

### Why `WeblogEntryWrapper` Absorbs Service Logic

Velocity templates in Apache Roller access entry data via `$model.weblogEntry.getComments()`. The `$model.weblogEntry` reference is a `WeblogEntryWrapper` instance. Velocity's expression language requires all data to be accessible via Java getter methods on the model object — there is no way to write multi-statement Java code in a template.

Therefore, methods like `getComments()` **must** exist as single-method-call getters on the wrapper. Moving the service logic from `WeblogEntry` to `WeblogEntryWrapper` is the correct architectural placement: the wrapper is a **view-layer component** whose purpose is to bridge Velocity templates to the application's service layer.

### Why `getTransformedText()` and `getTransformedSummary()` Were Not Removed

These methods were listed as candidates in the refactoring plan. However, they were **already extracted** to `WeblogEntryContentHelper.java` in a prior refactoring (Instance 1.2). The remaining `getTransformedText()` and `getTransformedSummary()` on `WeblogEntry` are thin delegates to `WeblogEntryContentHelper.render()` — they convert plugin-tagged content to HTML. Since `WeblogEntryContentHelper` is a same-layer utility (it's in the `pojos` package), not a service manager, these methods don't constitute a hub-pattern violation.

### Why `getCommentsStillAllowed()` Was Retained

This method accesses `WebloggerRuntimeConfig` (a static configuration utility) rather than a service manager. It reads a boolean configuration property to determine if comments are still allowed based on weblog settings and a global days-limit. This is **configuration access**, not **service delegation** — it does not call a business service manager. Removing it would be over-aggressive and misidentify configuration access as service mediation.

### What Was Intentionally Not Changed

| Element | Why Untouched |
|---------|---------------|
| `WeblogEntry`'s JPA-mapped fields/relationships | Persistence contract must not change |
| `WeblogEntryWrapper`'s existing method signatures | Template compatibility must not change |
| `getCommentsStillAllowed()` | Accesses `WebloggerRuntimeConfig`, not a service manager |
| `getDisplayTitle()` / `getRss09xDescription()` | Pure computational methods on own data |
| `getTransformedText()` / `getTransformedSummary()` | Already refactored to use `WeblogEntryContentHelper` (same-layer utility) |
| `displayContent()` / `getDisplayContent()` | Content rendering that uses `WeblogEntryContentHelper` |
| `formatPubTime()` / `formatUpdateTime()` | Pure utility methods on own data |
| `createAnchorBase()` | Pure string computation on own data |

---

## 11. Architectural Impact

### Before
```
Template → WeblogEntryWrapper → WeblogEntry (POJO/Hub) → 3 Service Managers
                                       ↑                   + Permission system
Java Callers ──────────────────────────┘
```

The `WeblogEntry` POJO acted as a central hub connecting 60+ dependents to 3 service managers and the permission system. Every class that held a `WeblogEntry` reference had implicit transitive dependencies on `UserManager`, `WeblogEntryManager`, and `URLStrategy`.

### After
```
Template → WeblogEntryWrapper ──→ Service Managers (direct)
                   ↓
               WeblogEntry (pure data entity, no service deps)
                   ↑
Java Callers ──────┘ ──→ Service Managers (direct)
```

`WeblogEntry` is now a pure JPA entity. Its only concerns are:
- Persistent field access (getters/setters)
- Object identity (`equals`, `hashCode`, `toString`)
- Content transformation (`getTransformedText()` via `WeblogEntryContentHelper` — same-layer utility)
- Configuration queries (`getCommentsStillAllowed()` — static config, not service delegation)
- Date/string utilities (`formatPubTime()`, `createAnchorBase()`)

The service mediation responsibility is split:
- **`WeblogEntryWrapper`** handles template-facing service delegation (justified by Velocity constraints)
- **Direct service calls** handle Java-facing service access (explicit dependencies, testable)

### Dependency Graph Change

```
BEFORE: WeblogEntry imports 28 types including 3 service managers + WebloggerFactory
AFTER:  WeblogEntry imports 23 types — only persistence utilities and config
        WeblogEntryWrapper imports grew by 11 (absorbed service dependencies)
```

---

## 12. Limitations and Tradeoffs

| Limitation | Description | Why Acceptable |
|------------|-------------|----------------|
| **`WeblogEntryWrapper` grew** | +33 LOC, +11 imports — absorbs service dependencies removed from `WeblogEntry` | Architecturally correct: the wrapper IS the view-layer service mediator. Its purpose is to bridge templates to services. |
| **Java callers are more verbose** | `entry.getCreator()` becomes multiple lines with try-catch | Verbosity makes the service dependency explicit and visible. This is a feature, not a bug — hidden dependencies are worse than verbose explicit ones. |
| **15 files modified** | Moderate blast radius across handlers, servlets, utilities, and beans | Every change is mechanical (same service call, different invocation path). The test suite validates all changes. |
| **MetaWeblog permalink changed from manual URL to URLStrategy** | `getPermaLink()` (manual URLEncoder) replaced with `getWeblogEntryURL()` (URLStrategy) | Semantically equivalent — both produce absolute entry URLs. The URLStrategy version is more correct and consistent with the rest of the codebase. |
| **`WeblogEntryWrapper` could become a new hub** | It now has higher fan-out to service managers | This is its intended role. Unlike a POJO, a view-layer wrapper IS expected to mediate service access. The wrapper is request-scoped and non-persistent, so the coupling is appropriate for its architectural position. |

---

## 13. Future Extensibility Benefits

1. **Pure entity testing**: `WeblogEntry` can now be instantiated and tested without bootstrapping the Roller application context. Any code that only needs entry field data can use the entity directly without transitive service dependencies.

2. **Service substitution**: Callers that now explicitly reference `UserManager` or `WeblogEntryManager` can have those services mocked or substituted in tests. Previously, the service access was hidden inside `entry.getCreator()` and could not be intercepted.

3. **Clear architecture**: The dependency direction is now correct — services depend on entities, not vice versa. This enables standard layered architecture patterns and makes the codebase more understandable to new developers.

4. **Entity caching safety**: With no service-layer state accessed from the entity's methods, `WeblogEntry` can be safely placed in a JPA L2 cache without risk of stale service references or unexpected service calls during serialization.

5. **Independent evolution**: Changes to `UserManager`, `WeblogEntryManager`, or `URLStrategy` no longer affect `WeblogEntry.java`. The entity and service layers can evolve independently.

6. **URL consistency**: The removal of the duplicate `getPermaLink()` (manual URL construction) in favor of callers using `URLStrategy.getWeblogEntryURL()` ensures all URL generation goes through the centralized URL strategy, making future URL scheme changes easier.
